name: docker with ansible

on:
  workflow_dispatch:

env:
  HARBOR_REGISTRY: "aws.registry.trendmicro.com"
  HARBOR_IMAGE: "dddops-public/deploy-toolkit-aws"
  HARBOR_BRANCH: "int"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: check out
      uses: actions/checkout@v3.5.0

    - name: echo 1
      run: |
        ls -l
        echo $PWD
        printenv

    - name: Run docker
      env:
        deploy_toolkit: |
          docker run --privileged --rm --net=host \
                    -v /var/run/docker.sock:/var/run/docker.sock \
                    -v "${{ github.workspace }}":$HOME \
                    -w $HOME/ga/ansible \
                    hello-world
        command: |
          ansible-playbook local_playbook.yml \
                    -i host \
                    -v --extra-vars \
                    ' \
                    apply_testing_feature_flag="${apply_testing_feature_flag}" \
                    supported_app_names="${supported_app_names}" \
                    app_names="${app_names}" apply_cd="${apply_cd}" \
                    from_image_ver="${from_image_ver}" \
                    docker_image_ver="${docker_image_ver}"\
                    '

      run: |
        ls -l
        echo $PWD
        printenv
        ${{ env.deploy_toolkit }} ${{ env.command }}
